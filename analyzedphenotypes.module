<?php

/**
 * @file
 * The main functionality of this module.
 */


/**
 * Implements hook_menu().
 */
function analyzedphenotypes_menu() {
  $items = array();

  // ADMINISTRATIVE PAGES.
  $tripal_extension_basepath = 'admin/tripal/extension/';

  // Main administrative pages for analyzed phenotypes.
  $items[$tripal_extension_basepath . 'analyzedphenotypes'] = array(
    'title' => 'Analyzed Phenotypes',
    'description' => 'Lorem ipsum dolor sit amet (Hello Analyzedphenotypes).',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('analyzedphenotypes_admin_page_directory'),
    'access arguments' => array('access administration pages'),
    'file' => 'include/analyzedphenotypes.admin.form.inc',
    'type' => MENU_NORMAL_ITEM,
  );

  // Data Loader.
  $items[$tripal_extension_basepath . 'analyzedphenotypes/data_loader'] = array(
    'title' => 'Analyzed Phenotypes Data Loader',
    'description' => 'Lorem Ipsum dolor sit amet.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('analyzedphenotypes_admin_data_loader'),
    'access arguments' => array('access administration pages'),
    'file' => 'include/analyzedphenotypes.admin.form.inc',
    'type' => MENU_LOCAL_TASK,
    'weight' => 1,
  );

  // Generate data in JSON object.
  $items[$tripal_extension_basepath . 'analyzedphenotypes/json/%/%'] = array(
    'page callback' => 'analyzedphenotypes_data_json',
    'page arguments' => array(5, 6),
    'access arguments' => array('access administration pages'),
    'type' => MENU_CALLBACK,
  );


  // Generate validation result.
  $items[$tripal_extension_basepath . 'analyzedphenotypes/validation_result/%/%'] = array(
    'page callback' => 'analyzedphenotypes_validation_result',
    'page arguments' => array(5, 6),
    'access arguments' => array('access administration pages'),
    'type' => MENU_CALLBACK,
  );



  return $items;
}


module_load_include('inc', 'analyzedphenotypes', 'include/analyzedphenotypes.functions');
module_load_include('inc', 'analyzedphenotypes', 'include/analyzedphenotypes.validators');


/**
 * Implements hook_theme().
 */
function analyzedphenotypes_theme($existing, $type, $theme, $path) {
  $items = array();

  // Administrative page directory
  $items['analyzedphenotypes_admin_page_directory'] = array(
    'template' => 'analyzedphenotypes_pages',
    'render element' => 'form',
    'path' => $path . '/theme',
  );

  // Data loader.
  $items['analyzedphenotypes_admin_data_loader'] = array(
    'render element' => 'form',
    'template' => 'analyzedphenotypes_pages',
    'path' => $path . '/theme',
  );

  // Report errors generated by validators.
  $items['analyzedphenotypes_validator_report'] = array(
    'template' => 'analyzedphenotypes_validators',
    'path' => $path . '/theme',
  );

  return $items;
}


/**
 * Implements hook_theme().
 */
function analyzedphenotypes_preprocess_analyzedphenotypes_admin_page_directory(&$variables, $hook) {
  $variables['directory'] = $variables['form']['#ap_admin_directory'];

  return $variables;
}

/**
 * Implements hook_theme().
 */
function analyzedphenotypes_preprocess_analyzedphenotypes_admin_data_loader(&$variables, $hook) {
  $variables['stage_title'] = $variables['form']['#ap_stage_title'];
  $variables['stages'] = $variables['form']['#ap_stage_indicators'];
  $variables['current_stage'] = $variables['form']['#ap_current_stage'];


  return $variables;
}



/**
 * Implements hook_libraries_info().
 */
function analyzedphenotypes_libraries_info() {


}


/**
 * Function callback: Fetch records and populate to autocomplete search fields.
 *
 * @param $data_type
 *   A string indicating the source of call and what type of data is requested.
 *   eg. Projects, ontology etc.
 *
 * @return
 *   A JSON object.
 */
function analyzedphenotypes_data_json($datatype, $data, $key = '') {
  $arr_data = array();

  switch($datatype) {
    //
    case 'projects':
      $arr_data = analyzedphenotypes_projectprop('project_pattern_match_name', $key);

      break;

    //
    case 'validate_jobstatus':
      // Variable $data is job_id.
      $job_id = $data;
      $job = tripal_get_job($job_id);

      if ($job) {
        $job_status = strtolower(trim($job->status));

        if ($job_status == 'completed') {
          // Job completed.
          $job_percent = 100;
          $job_message = 'Completed';

          if ($job->progress != '100') {
            // Set to 100 in case file read returns an empty value.
            // Happens when file read and write not in sync.
            db_update('tripal_jobs')
              ->fields(array('progress' => 100))
              ->condition('job_id', $job_id, '=')
              ->execution();
          }
        }
        else {
          // On going job.
          $tmp_dir = file_directory_temp();
          $filename = $tmp_dir . '/ap-validate-job-progress' . $job_id . '.txt';
          $file_content = file_get_contents($filename);

          $job_percent = (empty($file_content)) ? '...' : trim($file_content);
          $job_message = ($job_percent == '100' || $job_status == 'completed')
            ? 'Completed' : $job->status;
        }

        $arr_data = array(
          'percentage' => $job_percent,
          'message' => $job_message
        );
      }

      break;

    //
    case 'describe':
      return 0;
      break;

    //
    case 'save_jobstatus':
      break;

  }


  print drupal_json_output($arr_data);

  // Do not show the Drupal headers and formatting.
  // This is critical as if anything else is printed to the screen you will see
  // an AJAX error instead of your progress bar ;-).
  exit();
}
